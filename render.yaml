# Render Blueprint Configuration
# Auto-deploy from branch: deploy-test

services:
  # ========================================
  # PostgreSQL Database
  # ========================================
  - type: pserv
    name: readee-db
    env: docker
    plan: free
    region: singapore
    ipAllowList: []
    databases:
      - name: readee_db
        user: readee_user

  # ========================================
  # Backend - Spring Boot API
  # ========================================
  - type: web
    name: readee-backend
    env: java
    region: singapore
    plan: free
    branch: deploy-test
    buildCommand: cd be && chmod +x gradlew && ./gradlew clean build -x test
    startCommand: java -jar be/build/libs/app.jar
    envVars:
      # Database Configuration
      - key: DB_HOST
        fromDatabase:
          name: readee-db
          property: host
      - key: DB_PORT
        fromDatabase:
          name: readee-db
          property: port
      - key: DB_NAME
        fromDatabase:
          name: readee-db
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: readee-db
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: readee-db
          property: password
      - key: DB_SSLMODE
        value: require

      # JPA Configuration
      - key: JPA_DDL_AUTO
        value: update
      - key: JPA_SHOW_SQL
        value: false

      # JWT Configuration
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRATION_MS
        value: 86400000
      - key: JWT_EMAIL_VERIFICATION_EXPIRATION_MS
        value: 600000
      - key: JWT_ISSUER
        value: readee

      # Mail Configuration (SMTP)
      - key: MAIL_HOST
        sync: false
      - key: MAIL_PORT
        value: 587
      - key: MAIL_USERNAME
        sync: false
      - key: MAIL_PASSWORD
        sync: false
      - key: MAIL_SMTP_AUTH
        value: true
      - key: MAIL_SMTP_STARTTLS_ENABLE
        value: true
      - key: MAIL_FROM
        value: no-reply@readee.com
      - key: MAIL_VERIFICATION_BASE_URL
        sync: false

      # AWS S3 Configuration
      - key: AWS_ACCESS_KEY_ID
        sync: false
      - key: AWS_SECRET_KEY
        sync: false
      - key: AWS_REGION
        sync: false
      - key: AWS_S3_BUCKET
        sync: false

      # Audit Log Configuration
      - key: AUDIT_LOG_RETENTION_ENABLED
        value: true
      - key: AUDIT_LOG_RETENTION_DAYS
        value: 180
    autoDeploy: true
    healthCheckPath: /api/actuator/health

  # ========================================
  # Frontend - Next.js Application
  # ========================================
  - type: web
    name: readee-frontend
    env: node
    region: singapore
    plan: free
    branch: deploy-test
    buildCommand: cd fe && npm install && npm run build
    startCommand: cd fe && npm start
    envVars:
      - key: NODE_VERSION
        value: 22.19.0
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: readee-backend
          envVarKey: RENDER_EXTERNAL_URL
    autoDeploy: true
